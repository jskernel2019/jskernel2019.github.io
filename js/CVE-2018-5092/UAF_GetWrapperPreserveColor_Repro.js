#!/usr/bin/env node
var fs=require('fs')
var http = require('http');

var MainPageCode = '<script>\n';
MainPageCode += 'var worker = new Worker("worker0.js"); \n';
MainPageCode += 'var bc0 = new BroadcastChannel("test_channel"); \n';
MainPageCode += 'setTimeout(function(){ \n';
MainPageCode += 'try{ bc0.postMessage("n82z8laAh2f004");}catch(e){} \n';
MainPageCode += '}, 10); \n';
MainPageCode += 'setTimeout(function(){location.reload();},300); \n';
MainPageCode += '</script>\n';
var workercode = 'onerror  = function (e) {fetch("./fetchedfile0.html", {signal:abortSig0}).then(function(res) {res.text().then(function(txt) {}).catch(function(error) {});}).catch(function(error) {});\n';
workercode+=' };\n';
workercode+='var abortCtl0 = new AbortController();\n';
workercode+='var abortSig0 = abortCtl0.signal;\n';
workercode+='var bc0 = new BroadcastChannel("test_channel");\n';
workercode+='setInterval(function(){\n';
workercode+='try{ bc0.postMessage("");}catch(e){}\n';
workercode+=' xmlReq0.setRequestHeader("X-Custom-Header", "");\n';
workercode+='try{ close();} catch(e){}\n';
workercode+='}, 32);\n';
workercode+='var xmlReq0 = new XMLHttpRequest();\n';


var httpRootDirFiles=fs.readdirSync('.');
var server = http.createServer(function(request, response) {
	console.log('request.url' + request.url )

		if(request.url=='/'){
			response.writeHead(200);
		    response.write(MainPageCode);

		    response.end();
		}
		else if(request.url=='/worker0.js'){
			response.writeHead(200);
		    response.end(workercode);
		}
		else{
			response.writeHead(404);
			response.end();
		}

});

server.listen(12345, function(err) {
		console.log('Server listening port '+12345)
});


